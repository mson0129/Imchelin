<style type='text/css'>
body.overwatch {background: #000;}
body {background: #000;}
</style>
<div class='app' style=''>
    <div class='appBar'>
        <h2><a href='/randoms'>랜선웨어: 랜덤선택 프로그램</a></h2>
        <ul>
            <li><a href='#'>랜덤 선택</a></li>
        </ul>
    </div>
    <div class='view' style='margin: 0;'>
<!--<view>-->
<%-include(view)%>
<!--</view>-->
    </div>
</div>
<script type='text/javascript'>
function getRandomInt (min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

$(function() {
    $('button.orange').click(function() {$('div.appBar > ul > li:nth-child(1)').click();})
    $('ul.input#spots li').click(function () {
        $('ul.input#spots li').removeClass('selected');
        $(event.currentTarget).addClass('selected');

        var db;
        var request = indexedDB.open('imchelin', 3);
        request.onsuccess = function(event) {
            console.log('DB Opened');
            db = event.target.result;
            var keyword = ($('ul.input#spots li.selected').hasClass('kgit')) ? 20 : 13;
            console.log(keyword);
            var table = new Array;
            var transaction = db.transaction('dishes');
            var objectStore = transaction.objectStore('dishes');
            var request = objectStore.openCursor();
            request.onerror = function(event) {
                console.log('Cursor Error');
                console.log(event);
            }
            request.onsuccess = function(event) {
                var cursor = event.target.result;
                if(cursor) {
                    //LILKE %keyword%
                    //if(cursor.value.spots_no.indexOf(keyword) !== -1) {
                    if(cursor.value.spots_no == keyword) {
                        table.push(cursor.value);
                    }
                    cursor.continue();
                } else {
                    $('div.appBar > ul > li:nth-child(1)').off();
                    $('div.appBar > ul > li:nth-child(1)').click(function() {
                        var res = table[getRandomInt(0, table.length-1)];
                        $('section.result')[0].innerHTML = "<div class='card'>" + res.name + "<br />(" + res.restaurants + ")</div>";
                        console.log(res);
                    });
                }
            }
        }
    });
});

$.get('/api/getDishes', function(data) {
    var tableDishes = JSON.parse(data);
    var db;
    var request = indexedDB.open('imchelin', 3);
    request.onerror = function(event) {
        console.log('DB NOT Opened');
        console.log(event);
    };
    request.onupgradeneeded = function(event) {
        var db = event.target.result;
        
        var objectStore = db.createObjectStore('dishes', {keyPath: 'no'});
        objectStore.createIndex('name', 'name', {unique: false});
        objectStore.createIndex('description', 'description', {unique: false});
        objectStore.createIndex('price', 'price', {unique: false});
        objectStore.createIndex('grade', 'grade', {unique: false});
        objectStore.createIndex('title', 'title', {unique: false});
        objectStore.createIndex('comment', 'comment', {unique: false});
        objectStore.createIndex('restaurants_no', 'restaurants_no', {unique: false});
        objectStore.createIndex('restaurants', 'restaurants', {unique: false});
        objectStore.createIndex('spots_no', 'spots_no', {unique: false});
        objectStore.createIndex('spots', 'spots', {unique: false});
        objectStore.createIndex('tags', 'tags', {unique: false});

        tableDishes.forEach(function(value, index) {
            objectStore.add(value);
        });
        
        console.log('DB Upgraded');
    }
    request.onsuccess = function(event) {
        console.log('DB Opened');
        db = event.target.result;
        
        var transaction = db.transaction('dishes');
        var objectStore = transaction.objectStore('dishes');
        var index = objectStore.index('name');

        var keyword = 20;
        var table = new Array;
        var transaction = db.transaction('dishes');
        var objectStore = transaction.objectStore('dishes');
        var request = objectStore.openCursor();
        request.onerror = function(event) {
            console.log('Cursor Error');
            console.log(event);
        }
        request.onsuccess = function(event) {
            var cursor = event.target.result;
            if(cursor) {
                if(cursor.value.spots_no == keyword) {
                    table.push(cursor.value);
                }
                cursor.continue();
            } else {
                $('div.appBar > ul > li:nth-child(1)').click(function() {
                    var res = table[getRandomInt(0, table.length-1)];
                    $('section.result')[0].innerHTML = "<div class='card'>" + res.name + "<br />(" + res.restaurants + ")</div>";
                    console.log(res);
                });
            }
        }
    }; 
});

</script>